name: Development Pipeline
on:
  push:
    branches: [dev, dev-*]
  workflow_dispatch:
jobs:
  # Quick checks for fast feedback
  quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/actions/setup-nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          accept-flake-config: "true"
      - uses: ./.github/workflows/actions/check-actionlint
      - uses: ./.github/workflows/actions/check-brand
  # Format check (separate to avoid timing issues)
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/actions/setup-nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          accept-flake-config: "true"
      - uses: ./.github/workflows/actions/check-format
  # Eval configs
  eval-configs:
    name: Eval ${{ matrix.config }}
    needs: [quick-checks, format-check]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config: [nixos, darwin, homes]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/actions/setup-nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - uses: ./.github/workflows/actions/eval-configs
        with:
          config-type: ${{ matrix.config }}
  # SSH strict check (critical for dev)
  ssh-check:
    name: SSH Strict Check
    needs: [eval-configs]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/actions/setup-nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - uses: ./.github/workflows/actions/check-ssh-strict
        with:
          upload-artifact: "true"
