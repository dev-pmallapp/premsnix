name: CI Pipeline
on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:
jobs:
  # ============================================================
  # STAGE 1: CHECK - Linting and static analysis
  # ============================================================
  lint-workflows:
    name: "[CHECK] Lint Workflows"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - name: Run actionlint
        run: nix run nixpkgs#actionlint -- .github/workflows/*.yml
  format-check:
    name: "[CHECK] Format Check"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
          extra_nix_config: |
            accept-flake-config = true
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Check formatting
        run: nix fmt -- --fail-on-change
  brand-scan:
    name: "[CHECK] Brand Scan"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Scan for legacy branding
        run: |
          set -euo pipefail
          MATCHES=$(grep -RniE 'khaneli(vim|snow)?|khanelimac' . \
            --exclude-dir=.git \
            --exclude-dir=secrets \
            --exclude-dir=khanelimac \
            --exclude-dir=khanelimac-m1 \
            --exclude='result*' \
            --exclude=flake.lock \
            --exclude=brand-scan.yml \
            --exclude=ci.yml 2>/dev/null | \
            awk -F: '{
              match($0, /^[^:]+:[^:]+:(.*)$/, arr);
              line = arr[1];
              if (line !~ /^[[:space:]]*(#|\/\/|\/\*|\*|")/) print $0
            }' || true)
          if [ -n "${MATCHES}" ]; then
            echo "Forbidden legacy branding:" >&2
            echo "${MATCHES}" >&2
            exit 1
          fi
  deadnix:
    name: "[CHECK] Dead Code Analysis"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Run deadnix
        run: nix run nixpkgs#deadnix -- --fail .
  # ============================================================
  # STAGE 2: EVAL - Flake evaluation (parallel, depends on CHECK)
  # Includes: NixOS, Darwin, Home configurations + DevShells
  # ============================================================
  evaluate-nixos:
    name: "[EVAL] NixOS Configurations"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Evaluate NixOS configurations
        run: nix eval .#nixosConfigurations --apply 'builtins.attrNames'
  evaluate-darwin:
    name: "[EVAL] Darwin Configurations"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Evaluate Darwin configurations
        run: nix eval .#darwinConfigurations --apply 'builtins.attrNames'
  evaluate-homes:
    name: "[EVAL] Home Configurations"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Evaluate Home Manager configurations
        run: nix eval .#homeConfigurations --apply 'builtins.attrNames'
  evaluate-devshell-default:
    name: "[EVAL] DevShell - default"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.default --impure --no-link
  evaluate-devshell-c:
    name: "[EVAL] DevShell - c"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.c --impure --no-link
  evaluate-devshell-python:
    name: "[EVAL] DevShell - python"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.python --impure --no-link
  evaluate-devshell-rust:
    name: "[EVAL] DevShell - rust"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.rust --impure --no-link
  evaluate-devshell-nix:
    name: "[EVAL] DevShell - nix"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.nix --impure --no-link
  evaluate-devshell-migrator:
    name: "[EVAL] DevShell - migrator"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.migrator --impure --no-link
  # ============================================================
  # STAGE 3: BUILD - Build checks (depends on EVAL)
  # ============================================================
  build-nuc-v11:
    name: "[BUILD] nixos@nuc-v11"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build system
        run: nix build .#nixosConfigurations.nixos@nuc-v11.config.system.build.toplevel --no-link
  build-pmallapp-nixos:
    name: "[BUILD] pmallapp@nixos"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build system
        run: nix build .#nixosConfigurations.pmallapp@nixos.config.system.build.toplevel --no-link
  build-nuc-v09:
    name: "[BUILD] pmallapp@nuc-v09"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build system
        run: nix build .#nixosConfigurations.pmallapp@nuc-v09.config.system.build.toplevel --no-link
  build-premsnix:
    name: "[BUILD] pmallapp@premsnix"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build system
        run: nix build .#nixosConfigurations.pmallapp@premsnix.config.system.build.toplevel --no-link
  build-thinkpad:
    name: "[BUILD] pmallapp@thinkpad-p16s"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build system
        run: nix build .#nixosConfigurations.pmallapp@thinkpad-p16s.config.system.build.toplevel --no-link
  ssh-strict-check:
    name: "[BUILD] SSH Strict Check"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Run SSH strict check
        run: cd flake/dev && nix build .#checks.x86_64-linux.ssh-strict --impure
      - name: Build JSON summary
        run: cd flake/dev && nix build .#checks.x86_64-linux.ssh-strict-json --impure && cp result ../../ssh-strict-summary.json
      - name: Enforce failure threshold
        if: always()
        run: |
          if [ ! -f ssh-strict-summary.json ]; then
            echo "No summary JSON produced" >&2
            exit 1
          fi
          nix shell nixpkgs#jq -c jq -r '.failures' ssh-strict-summary.json > /tmp/failures
          FAILURES=$(cat /tmp/failures)
          if [ "$FAILURES" -gt 0 ]; then
            echo "SSH strict check reported $FAILURES failures" >&2
            exit 1
          fi
      - name: Upload summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ssh-strict-summary
          path: ssh-strict-summary.json
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f ssh-strict-summary.json ]; then
            SUMMARY=$(jq -r '. | "**Failures:** " + (.failures|tostring) + " | **Total Hosts:** " + (.totalHosts|tostring)' ssh-strict-summary.json)
            GLOBAL=$(jq -r '.global | "**Global:** AuthKeys=" + (.authorizedKeysPresent|tostring) + ", KnownHosts=" + (.knownHostsPresent|tostring)' ssh-strict-summary.json)
            HOST_TABLE=$(jq -r '.perHost | to_entries | map("| " + .key + " | " + .value.platform + " | " + .value.status + " | " + (.value.strict|tostring) + " | " + (.value.hostKeyPresent|tostring) + " | " + (.value.warnMissing|tostring) + " |") | ("| Host | Platform | Status | Strict | HostKey | WarnMissing |"), ("|------|----------|--------|--------|---------|-------------|"), .[]' ssh-strict-summary.json)
            BODY=$'## SSH Strict Check Summary\n\n'"$SUMMARY"$'\n'"$GLOBAL"$'\n\n### Per-Host Status\n\n'"$HOST_TABLE"$'\n'
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments -f body="$BODY"
          fi
  # ============================================================
  # STAGE 4: TEST - Validation and testing (depends on BUILD)
  # Matrix tests for check/eval/build stages
  # ============================================================
  test-check-stage:
    name: "[TEST] Check Stage - ${{ matrix.check }}"
    needs: [build-nuc-v11, build-pmallapp-nixos, build-nuc-v09, build-premsnix, build-thinkpad, ssh-strict-check]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        check: [actionlint, treefmt, brand-scan, deadnix]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
          extra_nix_config: |
            accept-flake-config = true
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Test ${{ matrix.check }}
        run: |
          case "${{ matrix.check }}" in
            actionlint)
              nix run nixpkgs#actionlint -- .github/workflows/*.yml
              ;;
            treefmt)
              nix fmt -- --fail-on-change
              ;;
            brand-scan)
              MATCHES=$(grep -RniE 'khaneli(vim|snow)?|khanelimac' . \
                --exclude-dir=.git --exclude-dir=secrets --exclude-dir=khanelimac \
                --exclude-dir=khanelimac-m1 --exclude='result*' --exclude=flake.lock \
                --exclude=brand-scan.yml --exclude=ci.yml 2>/dev/null | \
                awk -F: '{match($0, /^[^:]+:[^:]+:(.*)$/, arr); line = arr[1];
                if (line !~ /^[[:space:]]*(#|\/\/|\/\*|\*|")/) print $0}' || true)
              if [ -n "$MATCHES" ]; then
                echo "Brand check failed:" >&2
                echo "$MATCHES" >&2
                exit 1
              fi
              ;;
            deadnix)
              nix run nixpkgs#deadnix -- --fail .
              ;;
          esac
  test-eval-stage:
    name: "[TEST] Eval Stage - ${{ matrix.config }}"
    needs: [build-nuc-v11, build-pmallapp-nixos, build-nuc-v09, build-premsnix, build-thinkpad, ssh-strict-check]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config: [nixos, darwin, homes]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Test ${{ matrix.config }} evaluation
        run: |
          case "${{ matrix.config }}" in
            nixos)
              OUTPUT=$(nix eval .#nixosConfigurations --apply 'builtins.attrNames')
              echo "NixOS configs: $OUTPUT"
              [[ "$OUTPUT" =~ "nixos@nuc-v11" ]] || exit 1
              [[ "$OUTPUT" =~ "pmallapp@nixos" ]] || exit 1
              ;;
            darwin)
              OUTPUT=$(nix eval .#darwinConfigurations --apply 'builtins.attrNames')
              echo "Darwin configs: $OUTPUT"
              [[ "$OUTPUT" =~ "@" ]] || exit 1
              ;;
            homes)
              OUTPUT=$(nix eval .#homeConfigurations --apply 'builtins.attrNames')
              echo "Home configs: $OUTPUT"
              [[ "$OUTPUT" =~ "@" ]] || exit 1
              ;;
          esac
  test-devshells:
    name: "[TEST] DevShells - ${{ matrix.shell }}"
    needs: [build-nuc-v11, build-pmallapp-nixos, build-nuc-v09, build-premsnix, build-thinkpad, ssh-strict-check]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shell: [default, c, python, rust, nix, migrator]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Test ${{ matrix.shell }} devshell
        run: |
          cd flake/dev
          nix build .#devShells.x86_64-linux.${{ matrix.shell }} --impure --no-link
          # Verify essential tools are present
          case "${{ matrix.shell }}" in
            default)
              nix develop .#devShells.x86_64-linux.default --impure -c which nix
              ;;
            c)
              nix develop .#devShells.x86_64-linux.c --impure -c which gcc
              ;;
            python)
              nix develop .#devShells.x86_64-linux.python --impure -c which python
              nix develop .#devShells.x86_64-linux.python --impure -c which pytest
              ;;
            rust)
              nix develop .#devShells.x86_64-linux.rust --impure -c which cargo
              ;;
            nix)
              nix develop .#devShells.x86_64-linux.nix --impure -c which nix-diff
              ;;
            migrator)
              nix develop .#devShells.x86_64-linux.migrator --impure -c which nix
              ;;
          esac
  test-build-stage:
    name: "[TEST] Build Stage - ${{ matrix.host }}"
    needs: [build-nuc-v11, build-pmallapp-nixos, build-nuc-v09, build-premsnix, build-thinkpad, ssh-strict-check]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host:
          - nixos@nuc-v11
          - pmallapp@nixos
          - pmallapp@nuc-v09
          - pmallapp@premsnix
          - pmallapp@thinkpad-p16s
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Test ${{ matrix.host }} build
        run: |
          # Verify configuration exists
          nix eval .#nixosConfigurations.\"${{ matrix.host }}\".config.system.name
          # Test dry build (check derivation)
          nix build .#nixosConfigurations.\"${{ matrix.host }}\".config.system.build.toplevel --dry-run
          # Verify SSH strict mode is enabled
          STRICT=$(nix eval .#nixosConfigurations.\"${{ matrix.host }}\".config.premsnix.security.openssh.managedKeys.strict --json)
          if [ "$STRICT" != "true" ]; then
            echo "Host ${{ matrix.host }} does not have strict SSH mode enabled" >&2
            exit 1
          fi
  test-ssh-validation:
    name: "[TEST] SSH Validation Matrix"
    needs: [ssh-strict-check]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        check: [strict-flags, host-keys, global-keys, json-output]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Test ${{ matrix.check }}
        run: |
          case "${{ matrix.check }}" in
            strict-flags)
              # Verify all active hosts have strict=true
              cd flake/dev
              nix build .#checks.x86_64-linux.ssh-strict --impure
              ;;
            host-keys)
              # Verify host keys exist for all active hosts
              HOSTS="nuc-v11 nixos nuc-v09 premsnix thinkpad-p16s"
              for h in $HOSTS; do
                if [ ! -f "secrets/hosts/$h/ssh_host_ed25519_key" ]; then
                  echo "Missing host key for $h" >&2
                  exit 1
                fi
              done
              ;;
            global-keys)
              # Verify global SSH keys exist
              [ -f "secrets/users/pmallapp/authorized_keys" ] || exit 1
              [ -f "secrets/known_hosts" ] || exit 1
              ;;
            json-output)
              # Verify JSON summary format
              cd flake/dev
              nix build .#checks.x86_64-linux.ssh-strict-json --impure
              nix shell nixpkgs#jq -c jq -e '.failures >= 0 and .totalHosts > 0' result
              ;;
          esac
  # ============================================================
  # STAGE 5: FINAL - Summary and status (always runs)
  # ============================================================
  ci-summary:
    name: "[FINAL] CI Summary"
    if: always()
    needs: [test-check-stage, test-eval-stage, test-devshells, test-build-stage, test-ssh-validation]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          FAILED=""
          if [ "${{ needs.test-check-stage.result }}" != "success" ]; then FAILED="$FAILED test-check-stage"; fi
          if [ "${{ needs.test-eval-stage.result }}" != "success" ]; then FAILED="$FAILED test-eval-stage"; fi
          if [ "${{ needs.test-devshells.result }}" != "success" ]; then FAILED="$FAILED test-devshells"; fi
          if [ "${{ needs.test-build-stage.result }}" != "success" ]; then FAILED="$FAILED test-build-stage"; fi
          if [ "${{ needs.test-ssh-validation.result }}" != "success" ]; then FAILED="$FAILED test-ssh-validation"; fi

          if [ -n "$FAILED" ]; then
            echo "❌ CI tests failed:$FAILED"
            exit 1
          fi
          echo "✅ All CI tests passed"
