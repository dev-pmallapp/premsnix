name: Brand Scan
on:
  workflow_dispatch: # Manual trigger only, covered by ci.yml
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Scan for legacy branding
        run: |
          set -euo pipefail
          echo 'Scanning for legacy tokens in active code (excluding comments, secrets, deprecated dirs)'
          # Exclude: secrets, deprecated host dirs, flake.lock, brand-scan.yml itself, build results
          MATCHES=$(grep -RniE '' . \
            --exclude-dir=.git \
            --exclude-dir=secrets \
            --exclude='result*' \
            --exclude=flake.lock \
            --exclude=brand-scan.yml 2>/dev/null | \
            awk -F: '{
              # Get everything after the line number
              match($0, /^[^:]+:[^:]+:(.*)$/, arr);
              line = arr[1];
              # Skip if line content starts with comment markers
              if (line !~ /^[[:space:]]*(#|\/\/|\/\*|\*|")/) print $0
            }' || true)
          if [ -n "${MATCHES}" ]; then
            echo "Forbidden legacy branding in active code:" >&2
            echo "${MATCHES}" >&2
            exit 1
          fi
          echo 'No legacy branding in active code.'
