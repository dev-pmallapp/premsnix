name: SSH Strict Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  strict:
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64-linux, aarch64-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v23
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Enter dev shell (print tool versions)
        run: nix develop .#default -c bash -lc 'echo Using dev shell; command -v jq || echo jq missing; command -v sops || echo sops missing'
      - name: Show flake
        run: nix flake show || true
      - name: Run SSH strict check
        run: nix develop .#default -c bash -lc 'nix build .#checks.${{ matrix.arch }}.ssh-strict' || echo "strict check failed"
      - name: Build JSON summary (x86 only)
        if: matrix.arch == 'x86_64-linux'
        run: nix develop .#default -c bash -lc 'nix build .#checks.x86_64-linux.ssh-strict-json && cp result ssh-strict-summary.json' || echo "summary build failed"
      - name: Summarize
        if: always()
        run: |
          echo "SSH Strict Check completed for ${{ matrix.arch }}"
          if [ -f ssh-strict-summary.json ]; then
            echo "Summary JSON:"; cat ssh-strict-summary.json; fi
      - name: Enforce failure threshold
        if: always() && matrix.arch == 'x86_64-linux'
        run: |
          if [ ! -f ssh-strict-summary.json ]; then
            echo "No summary JSON produced on x86_64-linux; failing" >&2
            exit 1
          fi
          FAILURES=$(jq -r '.failures' ssh-strict-summary.json)
          echo "Detected failures=$FAILURES"
          if [ "$FAILURES" -gt 0 ]; then
            echo "Failing workflow: ssh strict check reported $FAILURES failures" >&2
            exit 1
          fi
      - name: Upload strict summary artifact
        if: always() && matrix.arch == 'x86_64-linux'
        uses: actions/upload-artifact@v4
        with:
          name: ssh-strict-summary
          path: ssh-strict-summary.json
      - name: Comment on PR with summary
        if: github.event_name == 'pull_request' && matrix.arch == 'x86_64-linux'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f ssh-strict-summary.json ]; then
            SUMMARY=$(jq -r '. | "Failures: " + (.failures|tostring) + ", Hosts: " + (.totalHosts|tostring)')
            HOST_TABLE=$(jq -r '.perHost | to_entries | map("| " + .key + " | " + .value.status + " | " + (.value.strict|tostring) + " | " + (.value.hostKeyPresent|tostring) + " |") | ("| Host | Status | Strict | HostKey |"), ("|------|--------|--------|---------|"), .[]' ssh-strict-summary.json)
            BODY=$'SSH Strict Summary:\n'"$SUMMARY"$'\n\n'"$HOST_TABLE"$'\n'
            echo "Posting PR comment:\n$BODY"
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments -f body="$BODY"
          else
            echo "No summary JSON to comment"
