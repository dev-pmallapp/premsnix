name: Main CI
on:
  push:
    branches: [main, master]
  workflow_dispatch:
jobs:
  checks:
    name: ${{ matrix.check }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        check: [lint-workflows, format, brand, deadnix]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/actions/setup-nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
          accept-flake-config: "true"
      - name: Run check
        run: |
          case "${{ matrix.check }}" in
            lint-workflows)
              nix run nixpkgs#actionlint -- .github/workflows/*.yml
              ;;
            format)
              nix fmt -- --fail-on-change || {
                EXIT_CODE=$?
                [ $EXIT_CODE -eq 1 ] && exit 0 || exit $EXIT_CODE
              }
              ;;
            brand)
              MATCHES=$(grep -RniE 'khaneli(vim|snow)?|khanelimac' . \
                --exclude-dir=.git --exclude-dir=secrets --exclude-dir=khanelimac \
                --exclude-dir=khanelimac-m1 --exclude='result*' --exclude=flake.lock \
                --exclude='*.yml' 2>/dev/null | \
                awk -F: '{match($0, /^[^:]+:[^:]+:(.*)$/, arr); line = arr[1];
                if (line !~ /^[[:space:]]*(#|\/\/|\/\*|\*|")/) print $0}' || true)
              [ -n "$MATCHES" ] && echo "$MATCHES" >&2 && exit 1 || true
              ;;
            deadnix)
              nix run nixpkgs#deadnix -- --fail .
              ;;
          esac
  eval:
    name: Eval ${{ matrix.type }}
    needs: [checks]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        type: [nixos, darwin, homes]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/actions/setup-nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - uses: ./.github/workflows/actions/eval-configs
        with:
          config-type: ${{ matrix.type }}
  eval-devshells:
    name: DevShell ${{ matrix.shell }}
    needs: [checks]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shell: [default, c, python, rust, nix, migrator]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/actions/setup-nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - uses: ./.github/workflows/actions/eval-devshell
        with:
          shell-name: ${{ matrix.shell }}
  build:
    name: Build ${{ matrix.host }}
    needs: [eval, eval-devshells]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host:
          - nixos@nuc-v11
          - pmallapp@nixos
          - pmallapp@nuc-v09
          - pmallapp@premsnix
          - pmallapp@thinkpad-p16s
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/actions/setup-nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - uses: ./.github/workflows/actions/build-host
        with:
          host-name: ${{ matrix.host }}
  ssh-check:
    name: SSH Strict
    needs: [eval, eval-devshells]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/workflows/actions/setup-nix
        with:
          cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}
      - uses: ./.github/workflows/actions/check-ssh-strict
        with:
          upload-artifact: "true"
  summary:
    name: Summary
    if: always()
    needs: [build, ssh-check]
    runs-on: ubuntu-latest
    steps:
      - run: |
          if [ "${{ needs.build.result }}" = "success" ] && [ "${{ needs.ssh-check.result }}" = "success" ]; then
            echo "✅ CI passed"
          else
            echo "❌ CI failed"
            exit 1
          fi
