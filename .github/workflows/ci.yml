name: CI Pipeline
on:
  push:
    branches: [main, master]
  pull_request:
  workflow_dispatch:
jobs:
  # ============================================================
  # STAGE 1: CHECK - Linting and static analysis
  # ============================================================
  lint-workflows:
    name: "[CHECK] Lint Workflows"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - name: Run actionlint
        run: nix run nixpkgs#actionlint -- .github/workflows/*.yml
  format-check:
    name: "[CHECK] Format Check"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
          extra_nix_config: |
            accept-flake-config = true
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Check formatting
        run: nix fmt -- --fail-on-change
  brand-scan:
    name: "[CHECK] Brand Scan"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Scan for legacy branding
        run: |
          set -euo pipefail
          MATCHES=$(grep -RniE 'khaneli(vim|snow)?|khanelimac' . \
            --exclude-dir=.git \
            --exclude-dir=secrets \
            --exclude-dir=khanelimac \
            --exclude-dir=khanelimac-m1 \
            --exclude='result*' \
            --exclude=flake.lock \
            --exclude=brand-scan.yml \
            --exclude=ci.yml 2>/dev/null | \
            awk -F: '{
              match($0, /^[^:]+:[^:]+:(.*)$/, arr);
              line = arr[1];
              if (line !~ /^[[:space:]]*(#|\/\/|\/\*|\*|")/) print $0
            }' || true)
          if [ -n "${MATCHES}" ]; then
            echo "Forbidden legacy branding:" >&2
            echo "${MATCHES}" >&2
            exit 1
          fi
  deadnix:
    name: "[CHECK] Dead Code Analysis"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Run deadnix
        run: nix run nixpkgs#deadnix -- --fail .
  # ============================================================
  # STAGE 2: EVAL - Flake evaluation (parallel, depends on CHECK)
  # Includes: NixOS, Darwin, Home configurations + DevShells
  # ============================================================
  evaluate-nixos:
    name: "[EVAL] NixOS Configurations"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Evaluate NixOS configurations
        run: nix eval .#nixosConfigurations --apply 'builtins.attrNames'
  evaluate-darwin:
    name: "[EVAL] Darwin Configurations"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Evaluate Darwin configurations
        run: nix eval .#darwinConfigurations --apply 'builtins.attrNames'
  evaluate-homes:
    name: "[EVAL] Home Configurations"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Evaluate Home Manager configurations
        run: nix eval .#homeConfigurations --apply 'builtins.attrNames'
  evaluate-devshell-default:
    name: "[EVAL] DevShell - default"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.default --impure --no-link
  evaluate-devshell-c:
    name: "[EVAL] DevShell - c"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.c --impure --no-link
  evaluate-devshell-python:
    name: "[EVAL] DevShell - python"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.python --impure --no-link
  evaluate-devshell-rust:
    name: "[EVAL] DevShell - rust"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.rust --impure --no-link
  evaluate-devshell-nix:
    name: "[EVAL] DevShell - nix"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.nix --impure --no-link
  evaluate-devshell-migrator:
    name: "[EVAL] DevShell - migrator"
    needs: [lint-workflows, format-check, brand-scan, deadnix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build devshell
        run: cd flake/dev && nix build .#devShells.x86_64-linux.migrator --impure --no-link
  # ============================================================
  # STAGE 3: BUILD - Build checks (depends on EVAL)
  # ============================================================
  build-nuc-v11:
    name: "[BUILD] nixos@nuc-v11"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build system
        run: nix build .#nixosConfigurations.nixos@nuc-v11.config.system.build.toplevel --no-link
  build-pmallapp-nixos:
    name: "[BUILD] pmallapp@nixos"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build system
        run: nix build .#nixosConfigurations.pmallapp@nixos.config.system.build.toplevel --no-link
  build-nuc-v09:
    name: "[BUILD] pmallapp@nuc-v09"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build system
        run: nix build .#nixosConfigurations.pmallapp@nuc-v09.config.system.build.toplevel --no-link
  build-premsnix:
    name: "[BUILD] pmallapp@premsnix"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build system
        run: nix build .#nixosConfigurations.pmallapp@premsnix.config.system.build.toplevel --no-link
  build-thinkpad:
    name: "[BUILD] pmallapp@thinkpad-p16s"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Build system
        run: nix build .#nixosConfigurations.pmallapp@thinkpad-p16s.config.system.build.toplevel --no-link
  ssh-strict-check:
    name: "[BUILD] SSH Strict Check"
    needs: [evaluate-nixos, evaluate-darwin, evaluate-homes, evaluate-devshell-default, evaluate-devshell-c, evaluate-devshell-python, evaluate-devshell-rust, evaluate-devshell-nix, evaluate-devshell-migrator]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v23
        with:
          install_url: https://releases.nixos.org/nix/nix-2.18.1/install
      - uses: cachix/cachix-action@v16
        with:
          name: premsnix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
      - name: Run SSH strict check
        run: cd flake/dev && nix build .#checks.x86_64-linux.ssh-strict --impure
      - name: Build JSON summary
        run: cd flake/dev && nix build .#checks.x86_64-linux.ssh-strict-json --impure && cp result ../../ssh-strict-summary.json
      - name: Enforce failure threshold
        if: always()
        run: |
          if [ ! -f ssh-strict-summary.json ]; then
            echo "No summary JSON produced" >&2
            exit 1
          fi
          nix shell nixpkgs#jq -c jq -r '.failures' ssh-strict-summary.json > /tmp/failures
          FAILURES=$(cat /tmp/failures)
          if [ "$FAILURES" -gt 0 ]; then
            echo "SSH strict check reported $FAILURES failures" >&2
            exit 1
          fi
      - name: Upload summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ssh-strict-summary
          path: ssh-strict-summary.json
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f ssh-strict-summary.json ]; then
            SUMMARY=$(jq -r '. | "**Failures:** " + (.failures|tostring) + " | **Total Hosts:** " + (.totalHosts|tostring)' ssh-strict-summary.json)
            GLOBAL=$(jq -r '.global | "**Global:** AuthKeys=" + (.authorizedKeysPresent|tostring) + ", KnownHosts=" + (.knownHostsPresent|tostring)' ssh-strict-summary.json)
            HOST_TABLE=$(jq -r '.perHost | to_entries | map("| " + .key + " | " + .value.platform + " | " + .value.status + " | " + (.value.strict|tostring) + " | " + (.value.hostKeyPresent|tostring) + " | " + (.value.warnMissing|tostring) + " |") | ("| Host | Platform | Status | Strict | HostKey | WarnMissing |"), ("|------|----------|--------|--------|---------|-------------|"), .[]' ssh-strict-summary.json)
            BODY=$'## SSH Strict Check Summary\n\n'"$SUMMARY"$'\n'"$GLOBAL"$'\n\n### Per-Host Status\n\n'"$HOST_TABLE"$'\n'
            gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments -f body="$BODY"
          fi
  # ============================================================
  # STAGE 4: FINAL - Summary and status (always runs)
  # ============================================================
  ci-summary:
    name: "[FINAL] CI Summary"
    if: always()
    needs: [build-nuc-v11, build-pmallapp-nixos, build-nuc-v09, build-premsnix, build-thinkpad, ssh-strict-check]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          FAILED=""
          if [ "${{ needs.build-nuc-v11.result }}" != "success" ]; then FAILED="$FAILED build-nuc-v11"; fi
          if [ "${{ needs.build-pmallapp-nixos.result }}" != "success" ]; then FAILED="$FAILED build-pmallapp-nixos"; fi
          if [ "${{ needs.build-nuc-v09.result }}" != "success" ]; then FAILED="$FAILED build-nuc-v09"; fi
          if [ "${{ needs.build-premsnix.result }}" != "success" ]; then FAILED="$FAILED build-premsnix"; fi
          if [ "${{ needs.build-thinkpad.result }}" != "success" ]; then FAILED="$FAILED build-thinkpad"; fi
          if [ "${{ needs.ssh-strict-check.result }}" != "success" ]; then FAILED="$FAILED ssh-strict-check"; fi

          if [ -n "$FAILED" ]; then
            echo "❌ CI checks failed:$FAILED"
            exit 1
          fi
          echo "✅ All CI checks passed"
